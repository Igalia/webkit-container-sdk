From f8565069d61ae79a8c87cd19621b7bb486f20a7f Mon Sep 17 00:00:00 2001
From: Philippe Normand <philn@igalia.com>
Date: Mon, 15 Sep 2025 11:06:12 +0100
Subject: [PATCH] Revert "meson: Isolate built plugins from cargo target
 directory"

This reverts commit b73a46c95a34dfde4d830bba0b9108e8379c7e80.
---
 cargo_wrapper.py    |  7 +------
 meson.build         | 27 +++++++++++++++++++++++++--
 plugins/meson.build | 27 ---------------------------
 3 files changed, 26 insertions(+), 35 deletions(-)
 delete mode 100644 plugins/meson.build

diff --git a/cargo_wrapper.py b/cargo_wrapper.py
index c40c2e2e..843f0bee 100644
--- a/cargo_wrapper.py
+++ b/cargo_wrapper.py
@@ -27,7 +27,6 @@ PARSER.add_argument('--examples', nargs="+", default=[])
 PARSER.add_argument('--lib-suffixes', nargs="+", default=[])
 PARSER.add_argument('--exe-suffix')
 PARSER.add_argument('--depfile')
-PARSER.add_argument('--target-dir', type=P, default=None)
 PARSER.add_argument('--disable-doc', action="store_true", default=False)
 
 
@@ -80,11 +79,7 @@ if __name__ == "__main__":
     logfile = open(logfile_path, mode="w", buffering=1, encoding='utf-8')
 
     print(opts, file=logfile)
-    # Use explicitly passed target dir or default to build_dir/target
-    if opts.target_dir:
-        cargo_target_dir = opts.target_dir
-    else:
-        cargo_target_dir = opts.build_dir / 'target'
+    cargo_target_dir = opts.build_dir / 'target'
 
     env = os.environ.copy()
     if 'PKG_CONFIG_PATH' in env:
diff --git a/meson.build b/meson.build
index 465b4253..3fdaa9b7 100644
--- a/meson.build
+++ b/meson.build
@@ -619,8 +619,31 @@ endif
 # get cmdline for rust
 extra_env += {'RUSTC': ' '.join(rustc.cmd_array())}
 
-# Build plugins in the plugins subdirectory
-subdir('plugins')
+plugins = []
+if output.length() > 0
+  rs_plugins = custom_target('gst-plugins-rs',
+    build_by_default: true,
+    output: output,
+    console: true,
+    install: true,
+    install_dir: plugins_install_dir,
+    depends: depends,
+    depfile: 'gst-plugins-rs.dep',
+    env: extra_env,
+    command: [cargo_wrapper,
+      'build',
+      meson.current_build_dir(),
+      meson.current_source_dir(),
+      meson.global_build_root(),
+      target,
+      get_option('prefix'),
+      get_option('libdir'),
+      '--packages', packages,
+      '--depfile', '@DEPFILE@',
+      '--lib-suffixes', library_suffixes,
+    ] + feature_args + extra_args)
+  plugins = rs_plugins.to_list()
+endif
 
 # This is used by GStreamer to static link Rust plugins into gst-full
 gst_plugins = []
diff --git a/plugins/meson.build b/plugins/meson.build
deleted file mode 100644
index 3fc16f25..00000000
--- a/plugins/meson.build
+++ /dev/null
@@ -1,27 +0,0 @@
-plugins = []
-rs_plugins = []
-if output.length() > 0
-  rs_plugins = custom_target('gst-plugins-rs',
-    build_by_default: true,
-    output: output,
-    console: true,
-    install: true,
-    install_dir: plugins_install_dir,
-    depends: depends,
-    depfile: 'gst-plugins-rs.dep',
-    env: extra_env,
-    command: [cargo_wrapper,
-      'build',
-      meson.current_build_dir(),
-      meson.current_source_dir() / '..',
-      meson.global_build_root(),
-      target,
-      get_option('prefix'),
-      get_option('libdir'),
-      '--packages', packages,
-      '--depfile', '@DEPFILE@',
-      '--lib-suffixes', library_suffixes,
-      '--target-dir', meson.current_build_dir() / '..' / 'target',
-    ] + feature_args + extra_args)
-  plugins = rs_plugins.to_list()
-endif
-- 
2.51.0

